<!DOCTYPE html>
<title>Updating pie chart d3 v4</title>
<meta charset="utf-8">
<style>
    body {
        font-family: "Helvetica Neue", Helvetica, Arial, sans-serif;
        margin: auto;
        position: relative;
        width: 960px;
    }

    text {
        font: 10px sans-serif;
    }

    form {
        position: absolute;
        right: 10px;
        top: 10px;
    }

    input {
        margin: 0 7px;
    }
</style>

<body>
    <form></form>
    <button id='btn1'>bnt1</button>
    <button id='btn2'>bnt2</button>
</body>
<script src="https://d3js.org/d3.v4.min.js"></script>
<script>


    var width = 175,
        height = 135,
        radius = Math.min(width, height) / 2;
    var color = d3.scaleOrdinal(d3.schemeCategory20);

    var pie = d3.pie()
        .value(function (d) { return d.count; })
        .padAngle(0.04)
        .sort(null)

    var arc = d3.arc()
        .innerRadius(radius * 0.85)
        .outerRadius(radius)
        .cornerRadius(5)

    var svg = d3.select("body").append("svg")
        .attr("width", width)
        .attr("height", height)
        .attr('viewBox', '0 0 ' + this.width + ' ' + this.height) //当宽高改变时，图表响应式
        .attr('style', 'width:100%')
        .append("g")
        .attr("transform", "translate(" + width / 2 + "," + height / 2 + ")");

    let region1 = {
        key: "Apples",
        values: [
            { region: "inline", count: 53245 },
            { region: "outline", count: 28479 }
        ]
    }
    let region2 = {
        key: "Oranges",
        values: [{ region: "inline", count: 200 },
        { region: "outline", count: 200 },
        ]
    }
    document.getElementById('btn1').onclick = function () {
        change(region1)
    }
    document.getElementById('btn2').onclick = function () {
        change(region2)
    }

    function change(region) {
        console.log(region)
        var path = svg.selectAll("path");
        var data0 = path.data(),
            data1 = pie(region.values);

        path = path.data(data1, key);

        path
            .transition()
            .duration(600)
            .attrTween("d", arcTween)

        path
            .enter()
            .append("path")
            .each(function (d, i) {
                var narc = findNeighborArc(i, data0, data1, key);
                if (narc) {

                    this._current = narc;
                    this._previous = narc;
                } else {
                    this._current = d;
                }
            })
            .attr("fill", function (d, i) {
                return color(d.data.region)
            })
            .transition()
            .duration(600)
            .attrTween("d", arcTween)
        path
            .exit()
            .transition()
            .duration(600)
            .attrTween("d", function (d, index) {
                console.log(this._previous)
                var currentIndex = this._previous.data.region;
                var i = d3.interpolateObject(d, this._previous);
                return function (t) {
                    return arc(i(t))
                }

            })
            .remove()
    }
    function key(d) {
        return d.data.region;
    }

    function type(d) {
        d.count = +d.count;
        return d;
    }

    function findNeighborArc(i, data0, data1, key) {
        var d;
        if (d = findPreceding(i, data0, data1, key)) {

            var obj = cloneObj(d)
            obj.startAngle = d.endAngle;
            return obj;

        } else if (d = findFollowing(i, data0, data1, key)) {

            var obj = cloneObj(d)
            obj.endAngle = d.startAngle;
            return obj;

        }

        return null


    }

    // Find the element in data0 that joins the highest preceding element in data1.
    function findPreceding(i, data0, data1, key) {
        var m = data0.length;
        while (--i >= 0) {
            var k = key(data1[i]);
            for (var j = 0; j < m; ++j) {
                if (key(data0[j]) === k) return data0[j];
            }
        }
    }

    // Find the element in data0 that joins the lowest following element in data1.
    function findFollowing(i, data0, data1, key) {
        var n = data1.length, m = data0.length;
        while (++i < n) {
            var k = key(data1[i]);
            for (var j = 0; j < m; ++j) {
                if (key(data0[j]) === k) return data0[j];
            }
        }
    }

    function arcTween(d) {

        var i = d3.interpolate(this._current, d);

        this._current = i(0);

        return function (t) {
            return arc(i(t))
        }

    }


    function cloneObj(obj) {
        var o = {};
        for (var i in obj) {
            o[i] = obj[i];
        }
        return o;
    }
</script>